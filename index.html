<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>魔法の笛 - Magic Flute (Chromatic + JSON Score + MusicXML)</title>

    <!-- OSMD (MusicXML ビューア) -->
    <script src="https://unpkg.com/opensheetmusicdisplay/build/opensheetmusicdisplay.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }

        .app-container {
            width: 100%;
            max-width: 600px;
            height: 100vh;
            position: relative;
            padding: 20px;
        }

        /* OSMD パネル（MusicXML 読み込み＋表示） */
        .osmd-panel {
            position: absolute;
            left: 20px;
            right: 20px;
            top: 110px; /* 太陽ボタンより下に配置 */
            height: 150px;
            background: rgba(255, 255, 255, 0.92);
            border-radius: 10px;
            padding: 6px 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            overflow: hidden;
        }

        .osmd-controls {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
        }

        .osmd-controls label {
            font-weight: 600;
        }

        .xml-file-input {
            font-size: 10px;
            max-width: 55%;
        }

        .xml-button {
            border: none;
            border-radius: 999px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            background: rgba(102, 126, 234, 0.9);
            color: #fff;
        }

        .xml-button.playing {
            background: rgba(76, 175, 80, 0.9);
        }

        .osmd-container {
            flex: 1;
            overflow: auto;
        }

        /* 星型ボタン（メイン演奏用・半音込み16キー） */
        .star-buttons {
            position: absolute;
            left: 50%;
            top: 48%;
            transform: translate(-50%, -50%);
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            width: 320px;
        }

        .star-button {
            width: 76px;
            height: 76px;
            background: radial-gradient(circle, #ffeb3b 0%, #ffc107 100%);
            clip-path: polygon(
                50% 0%,
                61% 35%,
                98% 35%,
                68% 57%,
                79% 91%,
                50% 70%,
                21% 91%,
                32% 57%,
                2% 35%,
                39% 35%
            );
            cursor: pointer;
            transition: transform 0.1s, filter 0.1s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: bold;
            color: rgba(0, 0, 0, 0.85);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            text-align: center;
            line-height: 1.2;
            touch-action: none;
        }

        .star-button span.key-label {
            font-size: 11px;
            opacity: 0.8;
            margin-top: 2px;
        }

        .star-button.active {
            transform: scale(1.15) rotate(36deg);
            filter: brightness(1.3);
            box-shadow: 0 0 24px rgba(255, 235, 59, 1);
        }
        
        /* 太陽ボタン（音量コントロール） */
        .sun-button {
            position: absolute;
            right: 30px;
            top: 30px;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, #ffd700 0%, #ffa500 100%);
            border-radius: 50%;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5), 0 4px 15px rgba(0, 0, 0, 0.3);
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            touch-action: none;
            position: absolute;
        }

        .sun-button::before {
            content: '☀';
            filter: drop-shadow(2px 2px 3px rgba(0, 0, 0, 0.3));
        }

        .sun-button.dragging {
            cursor: grabbing;
            transform: scale(1.1);
        }

        .volume-indicator {
            position: absolute;
            right: 120px;
            top: 50px;
            font-size: 14px;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 20px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .volume-indicator.visible {
            opacity: 1;
        }

        /* JSON 楽譜パネル */
        .score-panel {
            position: absolute;
            left: 20px;
            right: 20px;
            bottom: 70px;
            background: rgba(0, 0, 0, 0.45);
            border-radius: 12px;
            padding: 8px 10px;
            color: #fff;
            font-size: 11px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .score-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .score-panel-title {
            font-weight: 600;
            font-size: 11px;
        }

        .score-panel-buttons {
            display: flex;
            gap: 6px;
        }

        .score-button {
            border: none;
            border-radius: 999px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        .score-button.playing {
            background: rgba(76, 175, 80, 0.9);
        }

        .score-textarea {
            width: 100%;
            min-height: 80px;
            max-height: 120px;
            resize: vertical;
            border-radius: 8px;
            border: none;
            padding: 6px;
            font-size: 11px;
            font-family: "Consolas", "SF Mono", monospace;
            background: rgba(0, 0, 0, 0.55);
            color: #e0e0e0;
            outline: none;
        }

        /* ヘルプテキスト */
        .help-text {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 10px;
            text-align: center;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 15px;
            border-radius: 20px;
        }

        /* レスポンシブ対応 */
        @media (max-width: 480px) {
            .star-buttons {
                width: 300px;
                gap: 14px;
            }
            
            .star-button {
                width: 70px;
                height: 70px;
                font-size: 12px;
            }

            .score-panel {
                bottom: 68px;
            }
        }

        @media (max-width: 360px) {
            .star-buttons {
                width: 280px;
                gap: 12px;
            }
            
            .star-button {
                width: 66px;
                height: 66px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 太陽ボタン（音量コントロール） -->
        <div class="sun-button" id="sunButton"></div>
        <div class="volume-indicator" id="volumeIndicator">Volume: 50%</div>

        <!-- OSMD パネル（MusicXML 読み込み＋表示＋自動演奏） -->
        <div class="osmd-panel">
            <div class="osmd-controls">
                <label for="xmlFileInput">MusicXML:</label>
                <input type="file" id="xmlFileInput" class="xml-file-input" accept=".xml,.musicxml,.mxl">
                <button id="xmlPlayButton" class="xml-button">Play XML</button>
            </div>
            <div id="osmdContainer" class="osmd-container"></div>
        </div>

        <!-- 星型ボタン（16音・半音込み） -->
        <div class="star-buttons" id="starButtons"></div>

        <!-- JSON 楽譜パネル -->
        <div class="score-panel">
            <div class="score-panel-header">
                <div class="score-panel-title">
                    JSON Score (bpm / tracks / notes)
                </div>
                <div class="score-panel-buttons">
                    <button class="score-button" id="scoreLoadSampleButton">Load Sample</button>
                    <button class="score-button" id="scorePlayButton">Play Score</button>
                </div>
            </div>
            <textarea id="scoreJson" class="score-textarea" spellcheck="false"></textarea>
        </div>

        <!-- ヘルプテキスト -->
        <div class="help-text">
            星16音（C4〜D#5 / 半音あり）: タップで演奏 / 上下ドラッグでピッチ変化 |
            キー: 1–4, QWER, ASDF, ZXCV | 太陽:音量 |
            JSON: Score 再生 | MusicXML: ファイル読み込み → Play XML
        </div>
    </div>

    <script>
        let audioContext;
        let mainGain;
        let isInitialized = false;
        let activeVoices = new Map();
        let nextNoteId = 0;
        let currentVolume = 0.5;

        // スコア再生用フラグ・タイマー（JSON用）
        let isScorePlaying = false;
        let scoreTimeouts = [];

        // OSMD 関連
        let osmd = null;
        let osmdNoteSequence = [];  // {isRest, halftone, durSec}
        let isXmlPlaying = false;
        let xmlStopRequested = false;

        // ===============================
        // 音名 → セント値（A4=0）変換用
        // ===============================
        const NOTE_TO_SEMITONE = {
            'C': -9,
            'C#': -8, 'Db': -8,
            'D': -7,
            'D#': -6, 'Eb': -6,
            'E': -5,
            'F': -4,
            'F#': -3, 'Gb': -3,
            'G': -2,
            'G#': -1, 'Ab': -1,
            'A': 0,
            'A#': 1, 'Bb': 1,
            'B': 2
        };

        function noteNameToFrequency(noteName) {
            const m = /^([A-G])([b#]?)(\d)$/.exec(noteName);
            if (!m) return null;
            const letter = m[1];
            const accidental = m[2] || '';
            const octave = parseInt(m[3], 10);
            const key = letter + accidental;
            if (!(key in NOTE_TO_SEMITONE)) return null;
            const semitoneFromA4 = NOTE_TO_SEMITONE[key] + 12 * (octave - 4);
            return 440 * Math.pow(2, semitoneFromA4 / 12);
        }

        // OSMD の halfTone（+12補正） → 周波数
        function midiToFrequency(midi) {
            return 440 * Math.pow(2, (midi - 69) / 12);
        }

        // 半音込み16キー設定（C4〜D#5）
        const starConfig = [
            { key: '1', note: 'C4',  gain: 1.6 },
            { key: '2', note: 'C#4', gain: 1.6 },
            { key: '3', note: 'D4',  gain: 1.5 },
            { key: '4', note: 'D#4', gain: 1.5 },

            { key: 'Q', note: 'E4',  gain: 1.4 },
            { key: 'W', note: 'F4',  gain: 1.3 },
            { key: 'E', note: 'F#4', gain: 1.2 },
            { key: 'R', note: 'G4',  gain: 1.1 },

            { key: 'A', note: 'G#4', gain: 1.0 },
            { key: 'S', note: 'A4',  gain: 0.9 },
            { key: 'D', note: 'A#4', gain: 0.9 },
            { key: 'F', note: 'B4',  gain: 0.8 },

            { key: 'Z', note: 'C5',  gain: 0.8 },
            { key: 'X', note: 'C#5', gain: 0.8 },
            { key: 'C', note: 'D5',  gain: 0.75 },
            { key: 'V', note: 'D#5', gain: 0.75 }
        ];

        // freq を追加
        starConfig.forEach(cfg => {
            cfg.freq = noteNameToFrequency(cfg.note);
        });

        // キー → インデックス、音名 → インデックス のマップ
        const keyIndexMap = {};
        const noteNameToStarIndex = {};
        starConfig.forEach((cfg, idx) => {
            keyIndexMap[cfg.key.toLowerCase()] = idx;
            noteNameToStarIndex[cfg.note] = idx;
        });

        function getGainForNoteName(noteName) {
            const idx = noteNameToStarIndex[noteName];
            if (idx != null) {
                return starConfig[idx].gain ?? 1.0;
            }
            return 1.0;
        }

        // ===============================
        // Audio 初期化
        // ===============================
        function initAudio() {
            if (isInitialized && audioContext) {
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                return;
            }
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            mainGain = audioContext.createGain();
            mainGain.connect(audioContext.destination);
            mainGain.gain.value = currentVolume;
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            isInitialized = true;
        }

        function ensureAudioRunning() {
            if (!audioContext) return;
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        function noteOn(frequency, idTag, gainFactor = 1.0) {
            if (!isInitialized) initAudio();
            ensureAudioRunning();
            
            const osc = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            osc.frequency.value = frequency;
            osc.type = 'sine';
            
            osc.connect(gainNode);
            gainNode.connect(mainGain);
            
            const now = audioContext.currentTime;
            const baseVoiceGain = 0.4; // 全体の基準
            let targetGain = baseVoiceGain * gainFactor;
            if (targetGain > 2.0) targetGain = 2.0;
            
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(targetGain, now + 0.03);
            
            osc.start(now);
            
            const noteId = `${idTag}_${nextNoteId++}`;
            activeVoices.set(noteId, { oscillator: osc, gainNode });
            return noteId;
        }

        function noteOff(noteId) {
            if (!noteId || !activeVoices.has(noteId)) return;
            const voice = activeVoices.get(noteId);
            const now = audioContext.currentTime;
            voice.gainNode.gain.cancelScheduledValues(now);
            voice.gainNode.gain.setValueAtTime(voice.gainNode.gain.value, now);
            voice.gainNode.gain.linearRampToValueAtTime(0, now + 0.2);
            voice.oscillator.stop(now + 0.25);
            setTimeout(() => {
                activeVoices.delete(noteId);
            }, 250);
        }

        // ===============================
        // UI 作成
        // ===============================
        function createUI() {
            const starButtonsContainer = document.getElementById('starButtons');
            starConfig.forEach((cfg, index) => {
                const star = document.createElement('div');
                star.className = 'star-button';
                star.dataset.index = index;
                star.dataset.freq = cfg.freq;
                star.dataset.note = cfg.note;
                star.dataset.key = cfg.key;
                star.innerHTML = `
                    ${cfg.note}
                    <span class="key-label">${cfg.key}</span>
                `;
                starButtonsContainer.appendChild(star);
            });

            // スコアテキストエリアにサンプルJSONセット
            const sampleJson = {
                "title": "Sample Scale",
                "bpm": 96,
                "timeSignature": "4/4",
                "tracks": [
                    {
                        "id": "melody",
                        "notes": [
                            { "t": 0, "dur": 1, "pitches": ["C4"] },
                            { "t": 1, "dur": 1, "pitches": ["D4"] },
                            { "t": 2, "dur": 1, "pitches": ["E4"] },
                            { "t": 3, "dur": 1, "pitches": ["F4"] },
                            { "t": 4, "dur": 1, "pitches": ["G4"] },
                            { "t": 5, "dur": 1, "pitches": ["A4"] },
                            { "t": 6, "dur": 1, "pitches": ["B4"] },
                            { "t": 7, "dur": 2, "pitches": ["C5"] }
                        ]
                    }
                ]
            };
            const scoreTextarea = document.getElementById('scoreJson');
            scoreTextarea.value = JSON.stringify(sampleJson, null, 2);
        }

        // ===============================
        // スコア再生機能（JSON）
        // ===============================
        function stopScorePlayback() {
            isScorePlaying = false;
            scoreTimeouts.forEach(id => clearTimeout(id));
            scoreTimeouts = [];

            // スコア由来の音を止める
            for (const [id, voice] of activeVoices.entries()) {
                if (id.startsWith('score_')) {
                    noteOff(id);
                }
            }

            // 星のハイライト解除
            const stars = document.querySelectorAll('.star-button');
            stars.forEach(star => star.classList.remove('active'));

            const btn = document.getElementById('scorePlayButton');
            if (btn) {
                btn.textContent = 'Play Score';
                btn.classList.remove('playing');
            }
        }

        function playScoreFromJsonTextarea() {
            initAudio();
            ensureAudioRunning();

            if (isScorePlaying) {
                // 再生中なら停止
                stopScorePlayback();
                return;
            }

            const textarea = document.getElementById('scoreJson');
            let data;
            try {
                data = JSON.parse(textarea.value);
            } catch (e) {
                alert('JSON のパースに失敗しました。\n' + e.message);
                return;
            }

            const bpm = data.bpm || 100;
            const beatDurationSec = 60 / bpm;
            const tracks = Array.isArray(data.tracks) ? data.tracks : [];
            if (!tracks.length || !Array.isArray(tracks[0].notes)) {
                alert('tracks[0].notes が見つかりません。');
                return;
            }

            const notes = tracks[0].notes;
            if (!notes.length) {
                alert('ノートがありません。');
                return;
            }

            isScorePlaying = true;
            const btn = document.getElementById('scorePlayButton');
            if (btn) {
                btn.textContent = 'Stop Score';
                btn.classList.add('playing');
            }

            const starsList = document.querySelectorAll('.star-button');
            scoreTimeouts = [];

            // 各ノートをスケジューリング
            notes.forEach((ev, idx) => {
                const tBeats = typeof ev.t === 'number' ? ev.t : 0;
                const durBeats = typeof ev.dur === 'number' ? ev.dur : 1;
                const startMs = tBeats * beatDurationSec * 1000;
                const durMs = durBeats * beatDurationSec * 1000;
                const pitches = Array.isArray(ev.pitches)
                    ? ev.pitches
                    : (ev.note ? [ev.note] : []);

                const startId = setTimeout(() => {
                    if (!isScorePlaying) return;

                    const noteIds = [];
                    const highlightedStars = [];

                    pitches.forEach(pName => {
                        const freq = noteNameToFrequency(pName);
                        if (!freq) return;

                        const starIndex = noteNameToStarIndex[pName];
                        if (starIndex != null) {
                            const st = starsList[starIndex];
                            if (st) {
                                st.classList.add('active');
                                highlightedStars.push(st);
                            }
                        }

                        const gainFactor = getGainForNoteName(pName);
                        const nid = noteOn(freq, `score_${idx}_${pName}`, gainFactor);
                        noteIds.push(nid);
                    });

                    const stopId = setTimeout(() => {
                        highlightedStars.forEach(st => st.classList.remove('active'));
                        noteIds.forEach(nid => noteOff(nid));
                    }, durMs * 0.95);

                    scoreTimeouts.push(stopId);
                }, startMs);

                scoreTimeouts.push(startId);
            });

            // 全体長を計算して最後に停止
            const totalBeats = notes.reduce((max, ev) => {
                const t = typeof ev.t === 'number' ? ev.t : 0;
                const d = typeof ev.dur === 'number' ? ev.dur : 1;
                return Math.max(max, t + d);
            }, 0);
            const endId = setTimeout(() => {
                stopScorePlayback();
            }, totalBeats * beatDurationSec * 1000 + 250);
            scoreTimeouts.push(endId);
        }

        // ===============================
        // OSMD: MusicXML 読み込み & ノート抽出
        // ===============================
        function initOsmd() {
            if (osmd) return;
            osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("osmdContainer", {
                autoResize: true,
                drawTitle: true
            });
        }

        function buildOsmdNoteSequence() {
            osmdNoteSequence = [];
            if (!osmd || !osmd.cursor) return;

            osmd.cursor.show();
            osmd.cursor.reset();

            const iterator = osmd.cursor.Iterator || osmd.cursor.iterator;
            if (!iterator) return;

            const maxSteps = 1e6;
            let steps = 0;

            while (!iterator.EndReached && steps < maxSteps) {
                const measure = iterator.CurrentMeasure;
                const bpm = (iterator.CurrentBpm || (measure && measure.TempoInBPM)) || 80;
                const quarterSec = 60 / bpm; // 四分音符の秒数

                const voices = iterator.CurrentVoiceEntries;
                for (const ve of voices) {
                    const notes = ve.Notes;
                    for (const note of notes) {
                        const lengthReal = note.Length.RealValue; // whole=1, quarter=0.25
                        const beats = lengthReal * 4;             // 四分音符換算の拍数
                        const durSec = beats * quarterSec;

                        const isRest = note.isRest();
                        const halftone = note.halfTone + 12; // OSMD 推奨補正

                        osmdNoteSequence.push({
                            isRest,
                            halftone,
                            durSec
                        });
                    }
                }

                iterator.moveToNext();
                steps++;
            }

            osmd.cursor.hide();
        }

        async function loadMusicXmlFromFile(file) {
            const text = await file.text();
            initOsmd();
            try {
                await osmd.load(text);
                osmd.render();
                buildOsmdNoteSequence();
                if (!osmdNoteSequence.length) {
                    alert("楽譜は読み込まれましたが、演奏できる音符が見つかりませんでした。");
                }
            } catch (err) {
                console.error(err);
                alert("MusicXML の読み込みに失敗しました。\n" + err);
            }
        }

        // ===============================
        // OSMD: 自動演奏
        // ===============================
        async function playOsmdSequence() {
            if (!osmdNoteSequence.length) {
                alert("MusicXML から音符がまだ読み込まれていません。ファイルを読み込んでください。");
                return;
            }

            initAudio();
            ensureAudioRunning();

            const btn = document.getElementById('xmlPlayButton');

            if (isXmlPlaying) {
                // すでに再生中 → 停止要求
                xmlStopRequested = true;
                return;
            }

            isXmlPlaying = true;
            xmlStopRequested = false;
            if (btn) {
                btn.textContent = "Stop XML";
                btn.classList.add("playing");
            }

            // シンプルに「順番通りに一音ずつ」再生（単声メロディ想定）
            for (let i = 0; i < osmdNoteSequence.length; i++) {
                if (xmlStopRequested) break;
                const ev = osmdNoteSequence[i];
                const durMs = ev.durSec * 1000;

                if (!ev.isRest) {
                    const freq = midiToFrequency(ev.halftone);
                    const gainFactor = 1.0;
                    const noteId = noteOn(freq, `xml_${i}`, gainFactor);

                    await new Promise(r => setTimeout(r, durMs * 0.9));
                    noteOff(noteId);
                    await new Promise(r => setTimeout(r, durMs * 0.1));
                } else {
                    await new Promise(r => setTimeout(r, durMs));
                }
            }

            isXmlPlaying = false;
            xmlStopRequested = false;
            if (btn) {
                btn.textContent = "Play XML";
                btn.classList.remove("playing");
            }
        }

        // ===============================
        // イベントリスナー
        // ===============================
        function setupEventListeners() {
            const stars = document.querySelectorAll('.star-button');
            stars.forEach(star => {
                star.addEventListener('pointerdown', (e) => {
                    e.preventDefault();
                    initAudio();
                    ensureAudioRunning();
                    
                    star.classList.add('active');
                    
                    const index = parseInt(star.dataset.index, 10);
                    const cfg = starConfig[index];
                    const freq = cfg.freq;
                    const gainFactor = cfg.gain ?? 1.0;
                    
                    const noteId = noteOn(freq, `star_${index}`, gainFactor);
                    star.dataset.noteId = noteId;
                    star.dataset.baseFreq = freq;
                    star.dataset.startY = e.clientY;
                    
                    star.setPointerCapture(e.pointerId);
                });
                
                star.addEventListener('pointermove', (e) => {
                    if (!star.dataset.noteId) return;
                    e.preventDefault();
                    
                    const noteId = star.dataset.noteId;
                    const voice = activeVoices.get(noteId);
                    if (!voice) return;
                    
                    const baseFreq = parseFloat(star.dataset.baseFreq);
                    const startY = parseFloat(star.dataset.startY);
                    const deltaY = startY - e.clientY;
                    
                    const octaves = deltaY / 200;
                    const factor = Math.pow(2, octaves);
                    const newFreq = baseFreq * factor;
                    
                    const now = audioContext.currentTime;
                    voice.oscillator.frequency.setValueAtTime(newFreq, now);
                });
                
                function endNote() {
                    star.classList.remove('active');
                    if (star.dataset.noteId) {
                        noteOff(star.dataset.noteId);
                        delete star.dataset.noteId;
                    }
                }
                
                star.addEventListener('pointerup', (e) => { e.preventDefault(); endNote(); });
                star.addEventListener('pointerleave', endNote);
                star.addEventListener('pointercancel', endNote);
            });
            
            const sunButton = document.getElementById('sunButton');
            const volumeIndicator = document.getElementById('volumeIndicator');
            let isDragging = false;
            let startY = 0;
            let startVolume = currentVolume;
            
            sunButton.addEventListener('pointerdown', (e) => {
                e.preventDefault();
                initAudio();
                ensureAudioRunning();
                
                isDragging = true;
                startY = e.clientY;
                startVolume = currentVolume;
                sunButton.classList.add('dragging');
                volumeIndicator.classList.add('visible');
                sunButton.setPointerCapture(e.pointerId);
            });
            
            sunButton.addEventListener('pointermove', (e) => {
                if (!isDragging) return;
                const deltaY = startY - e.clientY;
                const volumeChange = deltaY / 200;
                currentVolume = Math.max(0, Math.min(1, startVolume + volumeChange));
                if (mainGain) {
                    mainGain.gain.value = currentVolume;
                }
                volumeIndicator.textContent = `Volume: ${Math.round(currentVolume * 100)}%`;
            });
            
            function endVolumeDrag() {
                isDragging = false;
                sunButton.classList.remove('dragging');
                setTimeout(() => {
                    volumeIndicator.classList.remove('visible');
                }, 1000);
            }
            
            sunButton.addEventListener('pointerup', endVolumeDrag);
            sunButton.addEventListener('pointercancel', endVolumeDrag);
            
            // キーボード演奏
            const pressedKeys = new Map();
            document.addEventListener('keydown', (e) => {
                if (e.repeat) return;
                const key = e.key.toLowerCase();
                if (!isInitialized) initAudio();
                ensureAudioRunning();
                
                if (keyIndexMap.hasOwnProperty(key)) {
                    e.preventDefault();
                    const index = keyIndexMap[key];
                    const cfg = starConfig[index];
                    const freq = cfg.freq;
                    const gainFactor = cfg.gain ?? 1.0;
                    
                    const starsList = document.querySelectorAll('.star-button');
                    const starElement = starsList[index];
                    if (starElement) {
                        starElement.classList.add('active');
                    }
                    
                    const noteId = noteOn(freq, `key_${key}`, gainFactor);
                    pressedKeys.set(key, { element: starElement, noteId });
                }
            });
            
            document.addEventListener('keyup', (e) => {
                const key = e.key.toLowerCase();
                if (pressedKeys.has(key)) {
                    const { element, noteId } = pressedKeys.get(key);
                    if (element) {
                        element.classList.remove('active');
                    }
                    noteOff(noteId);
                    pressedKeys.delete(key);
                }
            });

            // スコアボタン（JSON）
            const scorePlayButton = document.getElementById('scorePlayButton');
            scorePlayButton.addEventListener('click', () => {
                playScoreFromJsonTextarea();
            });

            const scoreLoadSampleButton = document.getElementById('scoreLoadSampleButton');
            scoreLoadSampleButton.addEventListener('click', () => {
                const sampleJson = {
                    "title": "Sample Scale",
                    "bpm": 96,
                    "timeSignature": "4/4",
                    "tracks": [
                        {
                            "id": "melody",
                            "notes": [
                                { "t": 0, "dur": 1, "pitches": ["C4"] },
                                { "t": 1, "dur": 1, "pitches": ["D4"] },
                                { "t": 2, "dur": 1, "pitches": ["E4"] },
                                { "t": 3, "dur": 1, "pitches": ["F4"] },
                                { "t": 4, "dur": 1, "pitches": ["G4"] },
                                { "t": 5, "dur": 1, "pitches": ["A4"] },
                                { "t": 6, "dur": 1, "pitches": ["B4"] },
                                { "t": 7, "dur": 2, "pitches": ["C5"] }
                            ]
                        }
                    ]
                };
                const scoreTextarea = document.getElementById('scoreJson');
                scoreTextarea.value = JSON.stringify(sampleJson, null, 2);
            });

            // MusicXML ファイル読み込み
            const xmlFileInput = document.getElementById('xmlFileInput');
            xmlFileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                await loadMusicXmlFromFile(file);
            });

            // MusicXML 自動演奏ボタン
            const xmlPlayButton = document.getElementById('xmlPlayButton');
            xmlPlayButton.addEventListener('click', () => {
                playOsmdSequence();
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            createUI();
            setupEventListeners();
            document.addEventListener('pointerdown', () => {
                initAudio();
                ensureAudioRunning();
            }, { once: true });
        });

        document.addEventListener('touchmove', (e) => {
            if (e.target.closest('.sun-button') || e.target.closest('.star-button')) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>
