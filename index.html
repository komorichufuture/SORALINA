<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>魔法の笛 - Magic Flute</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }

        .app-container {
            width: 100%;
            max-width: 600px;
            height: 100vh;
            position: relative;
            padding: 20px;
        }

        /* 星型ボタン（メイン演奏用） */
        .star-buttons {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            width: 320px;
        }

        .star-button {
            width: 76px;
            height: 76px;
            background: radial-gradient(circle, #ffeb3b 0%, #ffc107 100%);
            clip-path: polygon(
                50% 0%,
                61% 35%,
                98% 35%,
                68% 57%,
                79% 91%,
                50% 70%,
                21% 91%,
                32% 57%,
                2% 35%,
                39% 35%
            );
            cursor: pointer;
            transition: transform 0.1s, filter 0.1s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: bold;
            color: rgba(0, 0, 0, 0.85);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            text-align: center;
            line-height: 1.2;
            touch-action: none;
        }

        .star-button span.key-label {
            font-size: 11px;
            opacity: 0.8;
            margin-top: 2px;
        }

        .star-button.active {
            transform: scale(1.15) rotate(36deg);
            filter: brightness(1.3);
            box-shadow: 0 0 24px rgba(255, 235, 59, 1);
        }
        
        /* 太陽ボタン（音量コントロール） */
        .sun-button {
            position: absolute;
            right: 30px;
            top: 30px;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, #ffd700 0%, #ffa500 100%);
            border-radius: 50%;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5), 0 4px 15px rgba(0, 0, 0, 0.3);
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            touch-action: none;
            position: relative;
        }

        .sun-button::before {
            content: '☀';
            filter: drop-shadow(2px 2px 3px rgba(0, 0, 0, 0.3));
        }

        .sun-button.dragging {
            cursor: grabbing;
            transform: scale(1.1);
        }

        .volume-indicator {
            position: absolute;
            right: 120px;
            top: 50px;
            font-size: 14px;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 20px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .volume-indicator.visible {
            opacity: 1;
        }

        /* ヘルプテキスト */
        .help-text {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 11px;
            text-align: center;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 15px;
            border-radius: 20px;
        }

        /* レスポンシブ対応 */
        @media (max-width: 480px) {
            .star-buttons {
                width: 300px;
                gap: 14px;
            }
            
            .star-button {
                width: 70px;
                height: 70px;
                font-size: 12px;
            }
        }

        @media (max-width: 360px) {
            .star-buttons {
                width: 280px;
                gap: 12px;
            }
            
            .star-button {
                width: 66px;
                height: 66px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 太陽ボタン（音量コントロール） -->
        <div class="sun-button" id="sunButton"></div>
        <div class="volume-indicator" id="volumeIndicator">Volume: 50%</div>

        <!-- 星型ボタン（16音・ドラッグでピッチ変更） -->
        <div class="star-buttons" id="starButtons"></div>

        <!-- ヘルプテキスト -->
        <div class="help-text">
            星16音（C4〜D6）: タップで演奏 / 上下ドラッグでピッチ変化 |
            キー: 1–4, QWER, ASDF, ZXCV | 太陽:音量
        </div>
    </div>

    <script>
        // Web Audio API セットアップ
        let audioContext;
        let mainGain;
        let isInitialized = false;
        
        // 発音管理
        let activeVoices = new Map(); // noteId -> {oscillator, gainNode}
        let nextNoteId = 0;
        
        // 音量管理
        let currentVolume = 0.5;
        
        // 16音定義（Cメジャー 2オクターブ＋D6）
        // C4 だけ gain を少し持ち上げて補正
        const notes = [
            { key: '1', note: 'C4', freq: 261.63, gain: 1.4 },
            { key: '2', note: 'D4', freq: 293.66, gain: 1.0 },
            { key: '3', note: 'E4', freq: 329.63, gain: 1.0 },
            { key: '4', note: 'F4', freq: 349.23, gain: 1.0 },

            { key: 'Q', note: 'G4', freq: 392.00, gain: 1.0 },
            { key: 'W', note: 'A4', freq: 440.00, gain: 1.0 },
            { key: 'E', note: 'B4', freq: 493.88, gain: 1.0 },
            { key: 'R', note: 'C5', freq: 523.25, gain: 1.0 },

            { key: 'A', note: 'D5', freq: 587.33, gain: 1.0 },
            { key: 'S', note: 'E5', freq: 659.25, gain: 1.0 },
            { key: 'D', note: 'F5', freq: 698.46, gain: 1.0 },
            { key: 'F', note: 'G5', freq: 783.99, gain: 1.0 },

            { key: 'Z', note: 'A5', freq: 880.00,  gain: 1.0 },
            { key: 'X', note: 'B5', freq: 987.77,  gain: 1.0 },
            { key: 'C', note: 'C6', freq: 1046.50, gain: 1.0 },
            { key: 'V', note: 'D6', freq: 1174.66, gain: 1.0 }
        ];

        // キー→インデックスのマップ
        const keyIndexMap = {};
        notes.forEach((n, idx) => {
            keyIndexMap[n.key.toLowerCase()] = idx;
        });

        // オーディオコンテキスト初期化
        function initAudio() {
            if (isInitialized && audioContext) {
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                return;
            }
            
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            mainGain = audioContext.createGain();
            mainGain.connect(audioContext.destination);
            mainGain.gain.value = currentVolume;

            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            isInitialized = true;
        }

        function ensureAudioRunning() {
            if (!audioContext) return;
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        // 音を鳴らす（gainFactor で音量補正）
        function noteOn(frequency, idTag, gainFactor = 1.0) {
            if (!isInitialized) initAudio();
            ensureAudioRunning();
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            
            oscillator.connect(gainNode);
            gainNode.connect(mainGain);
            
            const now = audioContext.currentTime;
            const baseVoiceGain = 0.9; // 全体の標準
            const targetGain = baseVoiceGain * gainFactor;
            
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(targetGain, now + 0.03);
            
            oscillator.start(now);
            
            const noteId = `${idTag}_${nextNoteId++}`;
            activeVoices.set(noteId, {
                oscillator: oscillator,
                gainNode: gainNode
            });
            
            return noteId;
        }

        // 音を止める
        function noteOff(noteId) {
            if (!noteId || !activeVoices.has(noteId)) return;
            
            const voice = activeVoices.get(noteId);
            const now = audioContext.currentTime;
            
            voice.gainNode.gain.cancelScheduledValues(now);
            voice.gainNode.gain.setValueAtTime(voice.gainNode.gain.value, now);
            voice.gainNode.gain.linearRampToValueAtTime(0, now + 0.2);
            
            voice.oscillator.stop(now + 0.25);
            
            setTimeout(() => {
                activeVoices.delete(noteId);
            }, 250);
        }

        // UI生成
        function createUI() {
            const starButtonsContainer = document.getElementById('starButtons');
            
            notes.forEach((n, index) => {
                const star = document.createElement('div');
                star.className = 'star-button';
                star.dataset.index = index;
                star.dataset.freq = n.freq;
                star.dataset.note = n.note;
                star.dataset.key = n.key;
                
                star.innerHTML = `
                    ${n.note}
                    <span class="key-label">${n.key}</span>
                `;
                
                starButtonsContainer.appendChild(star);
            });
        }

        // イベントリスナー設定
        function setupEventListeners() {
            // 星ボタン
            const stars = document.querySelectorAll('.star-button');
            stars.forEach(star => {
                star.addEventListener('pointerdown', (e) => {
                    e.preventDefault();
                    initAudio();
                    ensureAudioRunning();
                    
                    star.classList.add('active');
                    
                    const index = parseInt(star.dataset.index, 10);
                    const info = notes[index];
                    
                    const freq = info.freq;
                    const gainFactor = info.gain ?? 1.0;
                    
                    const noteId = noteOn(freq, `star_${index}`, gainFactor);
                    star.dataset.noteId = noteId;
                    star.dataset.baseFreq = freq;
                    star.dataset.startY = e.clientY;
                    
                    star.setPointerCapture(e.pointerId);
                });
                
                star.addEventListener('pointermove', (e) => {
                    if (!star.dataset.noteId) return;
                    e.preventDefault();
                    
                    const noteId = star.dataset.noteId;
                    const voice = activeVoices.get(noteId);
                    if (!voice) return;
                    
                    const baseFreq = parseFloat(star.dataset.baseFreq);
                    const startY = parseFloat(star.dataset.startY);
                    const deltaY = startY - e.clientY;
                    
                    const octaves = deltaY / 200;
                    const factor = Math.pow(2, octaves);
                    const newFreq = baseFreq * factor;
                    
                    const now = audioContext.currentTime;
                    voice.oscillator.frequency.setValueAtTime(newFreq, now);
                });
                
                star.addEventListener('pointerup', (e) => {
                    e.preventDefault();
                    star.classList.remove('active');
                    if (star.dataset.noteId) {
                        noteOff(star.dataset.noteId);
                        delete star.dataset.noteId;
                    }
                });
                
                star.addEventListener('pointerleave', () => {
                    star.classList.remove('active');
                    if (star.dataset.noteId) {
                        noteOff(star.dataset.noteId);
                        delete star.dataset.noteId;
                    }
                });
                
                star.addEventListener('pointercancel', () => {
                    star.classList.remove('active');
                    if (star.dataset.noteId) {
                        noteOff(star.dataset.noteId);
                        delete star.dataset.noteId;
                    }
                });
            });
            
            // 太陽ボタン
            const sunButton = document.getElementById('sunButton');
            const volumeIndicator = document.getElementById('volumeIndicator');
            let isDragging = false;
            let startY = 0;
            let startVolume = currentVolume;
            
            sunButton.addEventListener('pointerdown', (e) => {
                e.preventDefault();
                initAudio();
                ensureAudioRunning();
                
                isDragging = true;
                startY = e.clientY;
                startVolume = currentVolume;
                sunButton.classList.add('dragging');
                volumeIndicator.classList.add('visible');
                sunButton.setPointerCapture(e.pointerId);
            });
            
            sunButton.addEventListener('pointermove', (e) => {
                if (!isDragging) return;
                
                const deltaY = startY - e.clientY;
                const volumeChange = deltaY / 200;
                currentVolume = Math.max(0, Math.min(1, startVolume + volumeChange));
                
                if (mainGain) {
                    mainGain.gain.value = currentVolume;
                }
                
                volumeIndicator.textContent = `Volume: ${Math.round(currentVolume * 100)}%`;
            });
            
            sunButton.addEventListener('pointerup', () => {
                isDragging = false;
                sunButton.classList.remove('dragging');
                setTimeout(() => {
                    volumeIndicator.classList.remove('visible');
                }, 1000);
            });
            
            sunButton.addEventListener('pointercancel', () => {
                isDragging = false;
                sunButton.classList.remove('dragging');
                volumeIndicator.classList.remove('visible');
            });
            
            // キーボード対応
            const pressedKeys = new Map();
            
            document.addEventListener('keydown', (e) => {
                if (e.repeat) return;
                
                const key = e.key.toLowerCase();
                if (!isInitialized) initAudio();
                ensureAudioRunning();
                
                if (keyIndexMap.hasOwnProperty(key)) {
                    e.preventDefault();
                    const index = keyIndexMap[key];
                    const info = notes[index];
                    
                    const freq = info.freq;
                    const gainFactor = info.gain ?? 1.0;
                    
                    const starsList = document.querySelectorAll('.star-button');
                    const starElement = starsList[index];
                    if (starElement) {
                        starElement.classList.add('active');
                    }
                    
                    const noteId = noteOn(freq, `key_${key}`, gainFactor);
                    pressedKeys.set(key, { element: starElement, noteId: noteId });
                }
            });
            
            document.addEventListener('keyup', (e) => {
                const key = e.key.toLowerCase();
                
                if (pressedKeys.has(key)) {
                    const { element, noteId } = pressedKeys.get(key);
                    if (element) {
                        element.classList.remove('active');
                    }
                    noteOff(noteId);
                    pressedKeys.delete(key);
                }
            });
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            createUI();
            setupEventListeners();
            
            document.addEventListener('pointerdown', () => {
                initAudio();
                ensureAudioRunning();
            }, { once: true });
        });

        // タッチスクロール防止
        document.addEventListener('touchmove', (e) => {
            if (e.target.closest('.sun-button') || e.target.closest('.star-button')) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>
